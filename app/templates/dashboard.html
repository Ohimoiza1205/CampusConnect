{% extends "layout.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>Welcome back, {{ user.name.split(' ')[0] }}!</h2>
                <p class="text-muted">{{ user.major }} • {{ user.year }} • {{ user.campus }}</p>
            </div>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createSessionModal">
                    <i class="bi bi-plus-circle me-2"></i>Create Study Session
                </button>
            </div>
        </div>
        
        <!-- Study Matches -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-people me-2"></i>Your Study Matches
                </h5>
            </div>
            <div class="card-body">
                {% if matches %}
                <div class="row">
                    {% for match in matches %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    {% if match.user.profile_picture %}
                                        <img src="{{ match.user.profile_picture }}" alt="Profile" class="rounded-circle me-3" width="50" height="50">
                                    {% else %}
                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                            <i class="bi bi-person-fill text-white"></i>
                                        </div>
                                    {% endif %}
                                    <div>
                                        <h6 class="mb-0">{{ match.user.name }}</h6>
                                        <small class="text-muted">{{ match.user.major }} • {{ match.user.year }}</small>
                                    </div>
                                    <div class="ms-auto">
                                        <span class="badge bg-success">{{ "%.0f"|format(match.compatibility) }}% match</span>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <strong>Common courses:</strong>
                                    <div class="mt-1">
                                        {% for course in match.common_courses %}
                                        <span class="badge bg-light text-dark me-1">{{ course }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-geo-alt me-1"></i>Prefers: {{ match.user.preferred_location or 'Any location' }}
                                    </small>
                                </div>
                                <div>
                                    <small class="text-muted">
                                        <i class="bi bi-chat-dots me-1"></i>Study style: {{ match.user.study_style.title() }}
                                    </small>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-outline-primary btn-sm me-2" onclick="sendStudyRequest('{{ match.user.id }}')">
                                        <i class="bi bi-send me-1"></i>Send Study Request
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">No matches found yet</h5>
                    <p class="text-muted">Try updating your profile or adding more courses to find study buddies!</p>
                    <a href="{{ url_for('setup_profile') }}" class="btn btn-outline-primary">
                        <i class="bi bi-gear me-2"></i>Update Profile
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Upcoming Study Sessions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-event me-2"></i>Upcoming Study Sessions
                </h5>
            </div>
            <div class="card-body">
                {% if upcoming_sessions %}
                {% for session in upcoming_sessions %}
                <div class="d-flex align-items-center p-3 mb-2 bg-light rounded">
                    <div class="me-3">
                        <div class="bg-primary text-white rounded text-center p-2" style="min-width: 60px;">
                            <div class="fw-bold">{{ session.session_date.strftime('%d') }}</div>
                            <small>{{ session.session_date.strftime('%b') }}</small>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">{{ session.title }}</h6>
                        <p class="mb-1 text-muted">{{ session.course.name }}</p>
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>{{ session.session_date.strftime('%I:%M %p') }}
                            {% if session.location %}
                            <i class="bi bi-geo-alt ms-2 me-1"></i>{{ session.location }}
                            {% endif %}
                        </small>
                    </div>
                    <div>
                        <span class="badge bg-secondary">{{ session.participants|length }}/{{ session.max_participants }}</span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">No upcoming sessions</h5>
                    <p class="text-muted">Create a study session or join one from your matches!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-person-circle me-2"></i>Your Profile
                </h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture }}" alt="Profile" class="rounded-circle mb-2" width="80" height="80">
                    {% else %}
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 80px; height: 80px;">
                            <i class="bi bi-person-fill text-white" style="font-size: 2rem;"></i>
                        </div>
                    {% endif %}
                    <h6>{{ user.name }}</h6>
                    <p class="text-muted small mb-0">{{ user.email }}</p>
                </div>
                
                <div class="mb-3">
                    <strong>Courses:</strong>
                    <div class="mt-1">
                        {% for user_course in user.courses %}
                        <span class="badge bg-primary me-1 mb-1">{{ user_course.course.code }}</span>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Study Style:</strong>
                    <span class="badge bg-light text-dark">{{ user.study_style.title() if user.study_style else 'Not set' }}</span>
                </div>
                
                {% if user.preferred_location %}
                <div class="mb-3">
                    <strong>Preferred Location:</strong>
                    <p class="text-muted small mb-0">{{ user.preferred_location }}</p>
                </div>
                {% endif %}
                
                <a href="{{ url_for('setup_profile') }}" class="btn btn-outline-primary btn-sm w-100">
                    <i class="bi bi-pencil me-2"></i>Edit Profile
                </a>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>Quick Stats
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ matches|length }}</h4>
                        <small class="text-muted">Study Matches</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{ user.courses|length }}</h4>
                        <small class="text-muted">Courses</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Study Session Modal -->
<div class="modal fade" id="createSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Study Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createSessionForm">
                    <div class="mb-3">
                        <label for="sessionTitle" class="form-label">Session Title</label>
                        <input type="text" class="form-control" id="sessionTitle" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sessionCourse" class="form-label">Course</label>
                        <select class="form-select" id="sessionCourse" name="course_id" required>
                            <option value="">Select a course</option>
                            {% for user_course in user.courses %}
                            <option value="{{ user_course.course.id }}">{{ user_course.course.code }} - {{ user_course.course.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sessionDate" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="sessionDate" name="session_date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sessionLocation" class="form-label">Location (Optional)</label>
                        <input type="text" class="form-control" id="sessionLocation" name="location" placeholder="e.g., Main Library, Room 204">
                    </div>
                    
                    <div class="mb-3">
                        <label for="sessionDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="sessionDescription" name="description" rows="3" placeholder="What will you be studying?"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="maxParticipants" class="form-label">Max Participants</label>
                        <select class="form-select" id="maxParticipants" name="max_participants">
                            <option value="2">2 people</option>
                            <option value="3">3 people</option>
                            <option value="4" selected>4 people</option>
                            <option value="5">5 people</option>
                            <option value="6">6 people</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createStudySession()">Create Session</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function sendStudyRequest(userId) {
    // Simple alert for now - in a real app, this would send a request
    alert('Study request sent! (In a real app, this would send an email or notification)');
}

function createStudySession() {
    const form = document.getElementById('createSessionForm');
    const formData = new FormData(form);
    
    const data = {
        title: formData.get('title'),
        course_id: formData.get('course_id'),
        session_date: formData.get('session_date'),
        location: formData.get('location'),
        description: formData.get('description'),
        max_participants: formData.get('max_participants')
    };
    
    axios.post('/api/create_session', data)
        .then(response => {
            alert('Study session created successfully!');
            location.reload();
        })
        .catch(error => {
            alert('Error creating session: ' + (error.response?.data?.error || 'Unknown error'));
        });
}

// Set minimum date to today
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('sessionDate');
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    dateInput.min = now.toISOString().slice(0, 16);
});
</script>
{% endblock %}

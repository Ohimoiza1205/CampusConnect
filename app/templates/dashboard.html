<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - CampusConnect Purdue</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .match-card { transition: transform 0.2s; cursor: pointer; }
        .match-card:hover { transform: translateY(-5px); }
        .compatibility-badge { font-size: 0.9rem; font-weight: bold; }
        .purdue-gold { background-color: #CEB888; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark purdue-gold">
        <div class="container">
            <span class="navbar-brand">CampusConnect Purdue</span>
            <div class="d-flex align-items-center">
                <a href="{{ url_for('messages') }}" class="btn btn-outline-light me-2 position-relative">
                    <i class="bi bi-envelope"></i>
                    {% if unread_messages > 0 %}
                    <span class="badge bg-danger position-absolute top-0 start-100 translate-middle">{{ unread_messages }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('study_planner') }}" class="btn btn-outline-light me-2">
                    <i class="bi bi-calendar-check"></i>
                </a>
                <div class="dropdown">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        {{ session.user.name }}
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('setup_profile') }}">Profile Settings</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('messages') }}">Messages
                            {% if unread_messages > 0 %}<span class="badge bg-primary">{{ unread_messages }}</span>{% endif %}
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Welcome Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2>Welcome back, {{ user.name.split(' ')[0] }}! Boiler Up!</h2>
                <p class="text-muted">
                    <i class="bi bi-mortarboard me-1"></i>{{ user.major or 'Major not set' }} •
                    <i class="bi bi-calendar me-1"></i>{{ user.year or 'Year not set' }} •
                    <i class="bi bi-geo-alt me-1"></i>Purdue University
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="card purdue-gold text-white">
                    <div class="card-body text-center py-3">
                        <h4 class="mb-0">{{ matches|length }}</h4>
                        <small>Study Partners Found</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <!-- Study Matches -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Your Study Partners</h5>
                        <span class="badge bg-success">{{ matches|length }} Boilermakers found</span>
                    </div>
                    <div class="card-body">
                        {% if matches %}
                        <div class="row">
                            {% for match in matches %}
                            <div class="col-md-6 mb-3">
                                <div class="card match-card border-0 shadow-sm h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="rounded-circle d-flex align-items-center justify-content-center me-3 purdue-gold" style="width: 45px; height: 45px;">
                                                <i class="bi bi-person-fill text-white"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-0">{{ match.user.name }}</h6>
                                                <small class="text-muted">
                                                    {{ match.user.major or 'Major not set' }} • {{ match.user.year or 'Year not set' }}
                                                </small>
                                            </div>
                                            <span class="badge bg-success compatibility-badge">{{ "%.0f"|format(match.compatibility) }}%</span>
                                        </div>

                                        <!-- Match Details -->
                                        <div class="mb-2">
                                            <small class="fw-bold text-primary">Common Courses:</small>
                                            <div class="mt-1">
                                                {% for course in match.common_courses[:2] %}
                                                <span class="badge bg-light text-dark me-1 mb-1">{{ course }}</span>
                                                {% endfor %}
                                                {% if match.common_courses|length > 2 %}
                                                <span class="badge bg-secondary mb-1">+{{ match.common_courses|length - 2 }} more</span>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Compatibility Indicators -->
                                        <div class="mb-2">
                                            {% if match.same_major %}
                                            <span class="badge bg-primary me-1 mb-1"><i class="bi bi-mortarboard me-1"></i>Same Major</span>
                                            {% endif %}
                                            {% if match.same_location %}
                                            <span class="badge purdue-gold me-1 mb-1 text-white"><i class="bi bi-geo-alt me-1"></i>Same Location</span>
                                            {% endif %}
                                        </div>

                                        <!-- Study Preferences -->
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                <i class="bi bi-chat-dots me-1"></i>{{ match.user.preferences.title() }} Study
                                                {% if match.user.gpa %} • <i class="bi bi-trophy me-1"></i>{{ match.user.gpa }} GPA{% endif %}
                                            </small>
                                        </div>

                                        <!-- Bio Preview -->
                                        {% if match.user.bio %}
                                        <div class="mb-3">
                                            <small class="text-muted">{{ match.user.bio[:80] }}{% if match.user.bio|length > 80 %}...{% endif %}</small>
                                        </div>
                                        {% endif %}

                                        <!-- Action Buttons -->
                                        <div class="d-flex gap-2 mt-auto">
                                            <button class="btn btn-primary btn-sm flex-grow-1" onclick="sendStudyRequest({{ match.user.id }}, '{{ match.user.name }}')">
                                                <i class="bi bi-send me-1"></i>Send Message
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" onclick="viewProfile({{ match.user.id }})">
                                                <i class="bi bi-eye me-1"></i>View
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
                            <h5 class="mt-3">No study partners found yet</h5>
                            <p class="text-muted">Try updating your profile or adding more courses to find fellow Boilermakers!</p>
                            <a href="{{ url_for('setup_profile') }}" class="btn btn-primary">
                                <i class="bi bi-gear me-2"></i>Update Profile
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">
                <!-- Profile Summary -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-person-circle me-2"></i>Your Profile</h6>
                    </div>
                    <div class="card-body text-center">
                        <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3 purdue-gold" style="width: 80px; height: 80px;">
                            <i class="bi bi-person-fill text-white" style="font-size: 2.5rem;"></i>
                        </div>
                        <h6>{{ user.name }}</h6>
                        <p class="text-muted small mb-3">{{ user.email }}</p>

                        {% if user.major %}
                        <div class="mb-2">
                            <strong>Major:</strong>
                            <span class="badge purdue-gold text-white">{{ user.major }}</span>
                        </div>
                        {% endif %}

                        <div class="mb-2">
                            <strong>Study Style:</strong>
                            <span class="badge bg-light text-dark">{{ user.preferences.title() if user.preferences else 'Not set' }}</span>
                        </div>

                        <div class="mb-3">
                            <strong>Courses:</strong>
                            <div class="mt-1">
                                {% for course in user.courses[:4] %}
                                <span class="badge bg-secondary me-1 mb-1">{{ course.course_number }}</span>
                                {% endfor %}
                                {% if user.courses|length > 4 %}
                                <span class="badge bg-dark">+{{ user.courses|length - 4 }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <a href="{{ url_for('setup_profile') }}" class="btn btn-outline-primary btn-sm w-100">
                            <i class="bi bi-pencil me-2"></i>Edit Profile
                        </a>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('messages') }}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-envelope me-2"></i>View Messages
                                {% if unread_messages > 0 %}<span class="badge bg-primary">{{ unread_messages }}</span>{% endif %}
                            </a>
                            <a href="{{ url_for('study_planner') }}" class="btn btn-outline-success btn-sm">
                                <i class="bi bi-calendar-check me-2"></i>Study Planner
                            </a>
                            <button class="btn btn-outline-warning btn-sm" onclick="findStudyRoom()">
                                <i class="bi bi-geo-alt me-2"></i>Find Study Room
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Your Stats</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-primary">{{ matches|length }}</h4>
                                <small class="text-muted">Study Matches</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success">{{ user.courses|length }}</h4>
                                <small class="text-muted">Courses</small>
                            </div>
                        </div>
                        {% if user.gpa %}
                        <div class="text-center mt-3">
                            <h4 class="text-warning">{{ user.gpa }}</h4>
                            <small class="text-muted">Current GPA</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Study Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="messageForm">
                        <input type="hidden" id="recipientId" name="recipient_id">
                        <div class="mb-3">
                            <label class="form-label">To:</label>
                            <input type="text" class="form-control" id="recipientName" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subject:</label>
                            <input type="text" class="form-control" name="subject" value="Study Partner Request" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Message:</label>
                            <textarea class="form-control" name="content" rows="4" placeholder="Hi! I noticed we're taking similar courses. Would you like to study together?" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="sendMessage()">Send Message</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile View Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Student Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3 purdue-gold" style="width: 100px; height: 100px;">
                                <i class="bi bi-person-fill text-white" style="font-size: 3rem;"></i>
                            </div>
                            <h5 id="profileName"></h5>
                            <p class="text-muted" id="profileEmail"></p>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <strong>Major:</strong>
                                <span class="badge purdue-gold text-white ms-1" id="profileMajor"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Year:</strong>
                                <span id="profileYear"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Study Style:</strong>
                                <span class="badge bg-light text-dark ms-1" id="profilePreferences"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Preferred Location:</strong>
                                <span id="profileLocation"></span>
                            </div>
                            <div class="mb-3">
                                <strong>GPA:</strong>
                                <span id="profileGPA"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Bio:</strong>
                                <p id="profileBio" class="text-muted"></p>
                            </div>
                            <div class="mb-3">
                                <strong>Current Courses:</strong>
                                <div id="profileCourses"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="sendMessageFromProfile()">Send Message</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function sendStudyRequest(userId, userName) {
            document.getElementById('recipientId').value = userId;
            document.getElementById('recipientName').value = userName;
            
            document.querySelector('textarea[name="content"]').value = 
                `Hi ${userName}! I noticed we have some courses in common. Would you like to form a study group or meet up to prepare for upcoming exams? Boiler Up!`;
            
            new bootstrap.Modal(document.getElementById('messageModal')).show();
        }

        function sendMessage() {
            const form = document.getElementById('messageForm');
            const formData = new FormData(form);
            
            const data = {
                recipient_id: parseInt(formData.get('recipient_id')),
                subject: formData.get('subject'),
                content: formData.get('content'),
                message_type: 'study_request'
            };
            
            fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Message sent successfully! They will receive an email notification.');
                    bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
                    form.reset();
                } else {
                    alert('Error sending message: ' + result.error);
                }
            })
            .catch(error => {
                alert('Error sending message. Please try again.');
            });
        }

        function viewProfile(userId) {
            // Fetch user profile data from API
            fetch(`/get_user_profile/${userId}`)
            .then(response => response.json())
            .then(user => {
                if (user.error) {
                    alert('Error loading profile: ' + user.error);
                    return;
                }
                
                document.getElementById('profileName').textContent = user.name;
                document.getElementById('profileEmail').textContent = user.email;
                document.getElementById('profileMajor').textContent = user.major || 'Not specified';
                document.getElementById('profileYear').textContent = user.year || 'Not specified';
                document.getElementById('profilePreferences').textContent = user.preferences ? user.preferences.charAt(0).toUpperCase() + user.preferences.slice(1) : 'Not specified';
                document.getElementById('profileLocation').textContent = user.preferred_location || 'Not specified';
                document.getElementById('profileGPA').textContent = user.gpa || 'Not shared';
                document.getElementById('profileBio').textContent = user.bio || 'No bio provided';
                
                // Show courses
                const coursesDiv = document.getElementById('profileCourses');
                coursesDiv.innerHTML = '';
                if (user.courses && user.courses.length > 0) {
                    user.courses.forEach(course => {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-secondary me-1 mb-1';
                        badge.textContent = course.course_number;
                        badge.title = course.course_name;
                        coursesDiv.appendChild(badge);
                    });
                } else {
                    coursesDiv.innerHTML = '<span class="text-muted">No courses listed</span>';
                }
                
                // Store user ID for messaging
                window.currentProfileUserId = userId;
                window.currentProfileUserName = user.name;
                
                new bootstrap.Modal(document.getElementById('profileModal')).show();
            })
            .catch(error => {
                alert('Error loading profile. Please try again.');
            });
        }

        function sendMessageFromProfile() {
            if (window.currentProfileUserId && window.currentProfileUserName) {
                bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
                sendStudyRequest(window.currentProfileUserId, window.currentProfileUserName);
            }
        }

        function findStudyRoom() {
            const rooms = [
                'WALC - Room 1055 (Collaborative Space)',
                'WALC - Room 2020 (Presentation Room)', 
                'Hicks Library - Group Study Room A',
                'Stewart Center - Study Room 302',
                'MATH Library - Quiet Study Area',
                'Engineering Library - Group Study Room'
            ];
            
            const randomRoom = rooms[Math.floor(Math.random() * rooms.length)];
            alert(`Suggested study location:\n\n${randomRoom}\n\nIn a real app, this would show availability and allow booking!`);
        }
    </script>
</body>
</html>
